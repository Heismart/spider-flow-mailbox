package org.spiderflow.mailbox.executor.shape;

import java.util.Map;

import org.apache.commons.lang3.math.NumberUtils;
import org.spiderflow.context.SpiderContext;
import org.spiderflow.executor.ShapeExecutor;
import org.spiderflow.mailbox.utils.MailboxUtils;
import org.spiderflow.model.Shape;
import org.spiderflow.model.SpiderNode;
import org.springframework.mail.javamail.JavaMailSenderImpl;
import org.springframework.stereotype.Component;

@Component
public class MailboxExecutor implements ShapeExecutor {

	public static final String MAILBOX_HOST = "host";

	public static final String MAILBOX_PORT = "port";

	public static final String MAILBOX_USERNAME = "username";

	public static final String MAILBOX_PASSWORD = "password";

	public static final String MAILBOX_TIMEOUT = "timeout";

	public static final String MAILBOX_CONTEXT_KEY = "$mailbox_";

	@Override
	public String supportShape() {
		return "mailbox";
	}

	@Override
	public Shape shape() {
		Shape shape = new Shape();
		// web界面上显示的图标
		shape.setImage("data:image/jpeg;base64,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");
		// 拖放至容器里时默认的节点名称
		shape.setLabel("电子邮箱");
		// 模板文件名
		shape.setName("mailbox");
		// 鼠标移动至图标上显示的名称
		shape.setTitle("电子邮箱");
		return shape;
	}

	@Override
	public void execute(SpiderNode node, SpiderContext context, Map<String, Object> variables) {
		String host = node.getStringJsonValue(MAILBOX_HOST);
		int port = NumberUtils.toInt(node.getStringJsonValue(MAILBOX_PORT), 25);
		String username = node.getStringJsonValue(MAILBOX_USERNAME);
		String password = node.getStringJsonValue(MAILBOX_PASSWORD);
		int timeout = NumberUtils.toInt(node.getStringJsonValue(MAILBOX_TIMEOUT), 60000);
		JavaMailSenderImpl mailboxTemplate = MailboxUtils.createMailSender(host, port, username, password, timeout);
		context.put(MAILBOX_CONTEXT_KEY + node.getNodeId(), mailboxTemplate);
	}

}
